pipeline {
    agent any

    environment {
        DOCKER_HUB_CREDENTIALS = 'dockerhub-credentials'  // Utiliser les identifiants Jenkins pour DockerHub
    }

    stages {
        stage('GIT') {
            steps {
                git branch: 'AmineDridia_5NIDS1_G1',
                    url: 'https://github.com/yesminezaghdene03/5NIDS1_G1_TPFOYER'
            }
        }

        // Autres étapes de compilation, analyse, déploiement, etc.

        stage('Build Docker Image') {
            steps {
                sh 'sudo docker build -t aminedridia/tp-foyer:5.0.0 .'
            }
        }

        stage('Push Docker Image to DockerHub') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                    sh '''
                        sudo docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} 
                        sudo docker push aminedridia/tp-foyer:5.0.0
                    '''
                }
            }
        }

        stage('Run Docker Compose') {
            steps {
                script {
                    // Assurer le nettoyage des containers orphelins et des anciens containers
                    sh '''
                        sudo docker-compose down --remove-orphans 
                        sudo docker-compose up -d
                    '''
                }
            }
        }
    }

    post {
        always {
            emailext(
                subject: "Build de ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${currentBuild.result}",
                body: """<p>Bonjour,</p>
                         <p>Le build <b>#${env.BUILD_NUMBER}</b> du job <b>${env.JOB_NAME}</b> est terminé avec le statut <b>${currentBuild.result}</b>.</p>
                         <p>Cliquez <a href="${env.BUILD_URL}">ici</a> pour voir les détails du build.</p>""",
                to: 'aminedridia9@gmail.com'
            )
        }
    }
}
