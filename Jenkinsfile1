pipeline {
    agent any

    stages {
        stage('Pre-commit Security Hooks') {
            steps {
                script {
                    // Exécution de l'étape de pré-commit pour vérifier les hooks de sécurité
                    echo 'Exécution des pre-commit hooks pour vérification de sécurité'

                    // Vérifie si Python3 est installé pour exécuter les hooks de pré-commit
                    sh '''
                        if ! command -v python3 &> /dev/null; then
                            echo "Python3 n'est pas installé, veuillez l'installer avant de continuer."
                            exit 1
                        else
                            echo "Python3 est installé, exécution des hooks de sécurité."
                            pre-commit run --all-files
                        fi
                    '''
                }
            }
        }

        stage('GIT') {
            steps {
                git branch: 'AmineDridia_5NIDS1_G1',
                    url: 'https://github.com/yesminezaghdene03/5NIDS1_G1_TPFOYER'
            }
        }

        stage('Build Docker Image') {
            steps {
                sh 'sudo docker build -t aminedridia/tp-foyer:5.0.0 .'
            }
        }

        stage('Push Docker Image to DockerHub') {
            steps {
                sh '''
                    sudo docker login -u aminedridia -p adminamine
                    sudo docker push aminedridia/tp-foyer:5.0.0
                '''
            }
        }

        stage('Run Docker Compose') {
            steps {
                script {
                    sh '''
                        sudo docker-compose down
                        sudo docker-compose up -d
                    '''
                }
            }
        }
    }

    post {
        always {
            emailext(
                subject: "Build de ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${currentBuild.result}",
                body: """<p>Bonjour,</p>
                         <p>Le build <b>#${env.BUILD_NUMBER}</b> du job <b>${env.JOB_NAME}</b> est terminé avec le statut <b>${currentBuild.result}</b>.</p>
                         <p>Cliquez <a href="${env.BUILD_URL}">ici</a> pour voir les détails du build.</p>""",
                to: 'aminedridia9@gmail.com'
            )
        }
    }
}
